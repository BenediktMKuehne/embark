name: EMBArk default installation on Ubuntu

on:
  schedule:
    - cron: '0 0 * * *' # do it every day
#  push:
#    branches:
#      - '**'        # matches every branch
#  pull_request:
#    branches:
#      - '**'
#  # Allows you to run this workflow manually from the Actions tab
#  workflow_dispatch:

jobs:
  default-install:
    if: github.repository_owner == 'e-m-b-a'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: false
          swap-storage: true

      - name: Restore cached Docker image
        id: docker-cache-restore
        uses: actions/cache@v3
        with:
          path: docker-cache/emba-image.tar
          key: emba-docker-image-v1

      - name: Load Docker image from cache
        if: steps.docker-cache-restore.outputs.cache-hit == 'true'
        run: |
          docker load -i docker-cache/emba-image.tar


      - name: EMBArk default install
        uses: Wandalen/wretry.action@master
        with:
          command: sudo ./installer.sh -sd
          attempt_limit: 3

      - name: Save Docker image to cache
        if: steps.docker-cache-restore.outputs.cache-hit != 'true'
        run: |
          mkdir -p docker-cache
          docker save embeddedanalyzer/emba:latest -o docker-cache/emba-image.tar

      - name: EMBArk quick test
        run: |
            sudo apt-get update
            sudo apt-get install wget
            wget https://ftp.dlink.de/dir/dir-300/archive/driver_software/DIR-300_fw_revb_214b01_ALL_de_20130206.zip

      - name: EMBArk default tests
        run: echo "TODO" # 
